name: Trivy Base Image Scan

on:
  pull_request:

jobs:
  scan-base-images:
    runs-on: ubuntu-latest
    name: Scan base images from Dockerfiles

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.3
      
      - name: Extract and resolve base images from Dockerfiles
        run: |
          find . -type f \( -iname 'Dockerfile' -o -iname '*.Dockerfile' \) > dockerfiles.txt
          > resolved_images.txt

          echo "Found:"
          cat dockerfiles.txt

          while read file; do
            echo "Processing $file"
      
            # Extract ARG definitions
            declare -A args
            while IFS= read -r line; do
              if [[ "$line" =~ ^ARG[[:space:]]+([A-Za-z0-9_]+)=([^\"]+) ]]; then
                key="${BASH_REMATCH[1]}"
                value="${BASH_REMATCH[2]}"
                args[$key]="$value"
              fi
            done < "$file"
      
            # Extract FROM lines and resolve variables
            while IFS= read -r line; do
              if [[ "$line" =~ ^FROM[[:space:]]+(.+) ]]; then
                raw="${BASH_REMATCH[1]}"
                resolved="$raw"
                for key in "${!args[@]}"; do
                  resolved="${resolved//\$\{$key\}/${args[$key]}}"
                done
                echo "$resolved" >> resolved_images.txt
              fi
            done < "$file"
          done
      
          # Clean and deduplicate
          grep -v '^$' resolved_images.txt | sort -u > unique_base_images.txt
          echo "Base images to scan:"
          cat unique_base_images.txt

      - name: Scan base images with Trivy
        run: |
          while read image; do
            echo "üîç Scanning $image"
            trivy image --severity HIGH,CRITICAL --exit-code 1 "$image"
          done < unique_base_images.txt
